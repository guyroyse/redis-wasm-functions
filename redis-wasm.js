#!js api_version=1.0 name=wasm

let callCount = 0
let instance = null

redis.registerFunction('fizzbuzz', (client, n) => {

  if (instance === null) {
    const buffer = client.callRaw('GET', 'fizzbuzz')
    const fizzBuzzWasmFromRedis = new Uint8Array(buffer)

    const fizzBuzzWasmHardcoded = new Uint8Array([
      0x00,0x61,0x73,0x6d,0x01,0x00,0x00,0x00,0x01,0x0c,0x02,0x60,0x01,0x7f,0x01,0x7f,
      0x60,0x02,0x7f,0x7f,0x01,0x7f,0x03,0x03,0x02,0x00,0x01,0x07,0x0c,0x01,0x08,0x66,
      0x69,0x7a,0x7a,0x62,0x75,0x7a,0x7a,0x00,0x00,0x0a,0x44,0x02,0x32,0x01,0x02,0x7f,
      0x20,0x00,0x41,0x05,0x10,0x01,0x21,0x01,0x20,0x00,0x41,0x03,0x10,0x01,0x21,0x02,
      0x20,0x01,0x20,0x02,0x71,0x04,0x40,0x41,0x7d,0x0f,0x0b,0x20,0x01,0x04,0x40,0x41,
      0x7e,0x0f,0x0b,0x20,0x02,0x04,0x40,0x41,0x7f,0x0f,0x0b,0x20,0x00,0x0f,0x0b,0x0f,
      0x01,0x01,0x7f,0x20,0x00,0x20,0x01,0x70,0x21,0x02,0x20,0x02,0x45,0x0f,0x0b
    ])

    const module = new WebAssembly.Module(fizzBuzzWasmFromRedis)
    instance = new WebAssembly.Instance(module)
  }

  callCount++

  return {
    callCount,
    fizzbuzz: instance.exports.fizzbuzz(Number(n))
  }
})
